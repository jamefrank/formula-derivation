# 欧拉角/旋转矩阵/四元数运动微分方程

# 欧拉角微分方程推导

在学习MPC控制算法的时候，状态变量涉及到欧拉角，但是不明白欧拉角和角速度之间关系的计算公式，由此产生了推导的事情。

## 变量定义

### 坐标系定义

设定$i$表示全局坐标系，$b$表示与刚体固连的局部坐标系

### 欧拉角的旋转表述

将刚体绕固连坐标系$x,y,z$轴的旋转角度分别记为$\alpha,\beta,\gamma$

那么绕坐标轴的旋转矩阵，通过欧拉角可分别表述为
$$
R_x = \begin{bmatrix}
1 && 0 && 0 \\
0 && cos\alpha && -sin\alpha \\
0 && sin\alpha && cos\alpha 
\end{bmatrix}
$$

$$
R_y = \begin{bmatrix}
cos\beta && 0 && sin\beta \\
0 && 1 && 0 \\
-sin\beta && 0 && cos\beta 
\end{bmatrix}
$$

$$
R_z = \begin{bmatrix}
cos\gamma && -sin\gamma && 0 \\
sin\gamma && cos\gamma && 0 \\
0 && 0 && 1 
\end{bmatrix}
$$

### 点的坐标变换

假设刚体上有一点$P$ ，记该点在全局坐标系下的坐标为 $\vec{p}^i_t$ ，假设刚体绕固连坐标系中的$x,y,z$ 轴旋转后**（内旋）**（注意角度是在固连坐标系下的角度值），该点在全局坐标系下的坐标记为$\vec{p}^i_{t+1}$ ，那么存在如下关系：
$$
\begin{aligned}
\vec{p}^i_{t+1} &= R_{xyz}*\vec{p}^i_{t} \\
&= R_z*R_y*R_x*\vec{p}^i_{t} \\
&= \begin{bmatrix}
cos\beta*cos\gamma && sin\alpha*sin\beta*cos\gamma-cos\alpha*sin\gamma && sin\alpha*sin\gamma+cos\alpha*sin\beta*cos\gamma \\
cos\beta*sin\gamma && cos\alpha*cos\gamma+sin\alpha*sin\beta*sin\gamma && cos\alpha*sin\beta*sin\gamma-sin\alpha*cos\gamma \\
-sin\beta && sin\alpha*cos\beta && cos\alpha*cos\beta
\end{bmatrix} * \vec{p}^i_{t}
\end{aligned}
$$

### 角速度与欧拉角时间导数的关系

我们从旋转矩阵的微分方程很容易得到旋转矩阵和角速度之间的关系，同时知道旋转矩阵和欧拉角的关系，很容易想到使用旋转矩阵作为中间变量可以建立角速度和欧拉角时间导数之间的关系。

1. 全局坐标系角速度

   已知$\dot{R}_{ib}=S(\vec{\omega}_i)\cdot R_{ib}$

   可以得到如下推导
   $$
   \begin{aligned}
   S(\vec{\omega}_i) &= \dot{R}_{ib} \cdot R_{ib}^T \\
   &= {d{R}_{ib} \over dt} \cdot R_{ib}^T \\
   &= {d{R}_{xyz} \over dt} \cdot R_{ib}^T \\
   &= {d(R_zR_yR_x) \over dt} \cdot R_{ib}^T \\
   &= ({d(R_z) \over dt} R_y R_x + R_z{d(R_y) \over dt}R_x + R_zR_y{d(R_x) \over dt})\cdot R_{ib}^T \\
   &= ({d(R_z) \over dt} R_y R_x + R_z{d(R_y) \over dt}R_x + R_zR_y{d(R_x) \over dt})\cdot {R_{xyz}^T} \\
   &= ({d(R_z) \over dt} R_y R_x + R_z{d(R_y) \over dt}R_x + R_zR_y{d(R_x) \over dt})\cdot (R_z R_y R_x)^T \\
   &= ({d(R_z) \over dt} R_y R_x + R_z{d(R_y) \over dt}R_x + R_z R_y{d(R_x) \over dt})\cdot R_x^T R_y^T R_z^T \\
   &= {d(R_z) \over dt} R_z^T  + R_z {d(R_y) \over dt} R_y^T R_z^T + R_z R_y{d(R_x) \over dt}R_x^T R_y^T R_z^T \\
   &=  
   \begin{bmatrix}
   -sin\gamma && -cos\gamma && 0 \\
   cos\gamma && -sin\gamma && 0 \\
   0 && 0 && 0
   \end{bmatrix} {d\gamma \over dt} R_z^T +
   R_z \begin{bmatrix}
   -sin\beta && 0 && cos\beta \\
   0 && 0 && 0 \\
   -cos\beta && 0 && -sin\beta 
   \end{bmatrix} {d\beta \over dt} R_y^T R_z^T +
   R_z R_y \begin{bmatrix}
   0 && 0 && 0 \\
   0 && -sin\alpha && -cos\alpha \\
   0 && cos\alpha && -sin\alpha
   \end{bmatrix} {d\alpha \over dt}R_x^T R_y^T R_z^T  \\
   
   &=
   \begin{bmatrix}
   0 && -1 && 0 \\
   1 && 0 && 0 \\
   0 && 0 && 0
   \end{bmatrix} \dot{\gamma} +
   \begin{bmatrix}
   0 && 0 && cos\gamma \\
   0 && 0 && sin\gamma \\
   -cos\gamma && -sin\gamma && 0
   \end{bmatrix} \dot{\beta} +
   \begin{bmatrix}
   0 && sin\beta && cos\beta sin\gamma \\
   -sin\beta && 0 && -cos\beta cos\gamma \\
   -cos\beta sin\gamma && cos\beta cos\gamma && 0
   \end{bmatrix} \dot{\alpha}  \\
   
   &=
   \begin{bmatrix}
   0 && \dot{\alpha} sin\beta -\dot{\gamma} && \dot{\beta}cos\gamma+\dot{\alpha} cos\beta sin\gamma \\
   -\dot{\alpha} sin\beta +\dot{\gamma} && 0 && -\dot{\alpha} cos\beta cos\gamma+\dot{\beta} sin\gamma \\
   -\dot{\beta}cos\gamma-\dot{\alpha} cos\beta sin\gamma && \dot{\alpha} cos\beta cos\gamma-\dot{\beta} sin\gamma  && 0
   \end{bmatrix} \\
   
   &=
   \begin{bmatrix}
   0 && -{\omega}_z^i && {\omega}_y^i \\
   {\omega}_z^i && 0 && -{\omega}_x^i \\
   -{\omega}_y^i && {\omega}_x^i && 0
   \end{bmatrix}
   
   \end{aligned}
   $$

   对照矩阵的各个元素分量可以得知
   $$
   \begin{aligned}
   \vec{\omega}^i = 
   \begin{bmatrix}
   \omega_x^i \\
   \omega_y^i \\
   \omega_z^i
   \end{bmatrix}
   
   &=
   \begin{bmatrix}
   \dot{\alpha} cos\beta cos\gamma-\dot{\beta}sin\gamma \\
   \dot{\beta}cos\gamma+\dot{\alpha} cos\beta sin\gamma \\
   -\dot{\alpha} sin\beta + \dot{\gamma}
   \end{bmatrix} \\
   
   &= 
   \begin{bmatrix}
   cos\beta cos\gamma && -sin\gamma && 0 \\
   cos\beta sin\gamma && cos\gamma && 0 \\
   -sin\beta && 0 && 1
   \end{bmatrix}
   \begin{bmatrix}
   \dot{\alpha} \\
   \dot{\beta} \\
   \dot{\gamma}
   \end{bmatrix}
   
   \end{aligned}
   $$
   

   这里涉及到求取矩阵的逆，我们需要用到伴随矩阵法计算逆矩阵

   矩阵 ：$A=(a_{ij})_{nn}$ 

   余子式：将矩阵$A$的元素$a_{ij}$所在的第$i$行，第$j$列元素划去后，各元素按原来的排列顺序组成的$n-1$阶矩阵所确定的**行列式**称为元素$a_{ij}$的余子式，记为$M_{ij}$

   代数余子式：$A_{ij} = (-1)^{i+j} M_{ij}$ 称为元素$a_{ij}$​的代数余子式

   代数余子式矩阵：$C=(A_{ij})_{nn}$ 方阵$A$各元素的代数余子式组成的矩阵$C$叫做矩阵$A$的代数余子式矩阵

   伴随阵：$A^* = C^T$ 代数余子式矩阵的转置

   求逆：$A^{-1} = {A^{*} \over \begin{vmatrix}A\end{vmatrix}} $

   

   行列式的求取方法（按第$j$列展开），其实也可以按照行进行展开：$det(A)=\begin{vmatrix}A\end{vmatrix}=\sum_{i=1}^{n}a_{ij}A_{ij}$

   

   首先记
   $$
   A = \begin{bmatrix}
   cos\beta cos\gamma && -sin\gamma && 0 \\
   cos\beta sin\gamma && cos\gamma && 0 \\
   -sin\beta && 0 && 1
   \end{bmatrix}
   $$
   接下来计算$det(A)$,观察到第3列存在两个0,那如果按照第3列进行展开，计算会很简单，因此计算如下：
   $$
   \begin{aligned}
   det(A) &= a_{13}*A_{13} + a_{23}*A_{23} + a_{33}*A_{33} \\
   &= 1*A_{33} \\
   &= (-1)^(3+3) * M_{33} \\
   &= 
   \begin{vmatrix}
   cos\beta cos\gamma && -sin\gamma  \\
   cos\beta sin\gamma && cos\gamma  \\
   \end{vmatrix} \\
   &= cos\beta*(cos\gamma)^2 + cos\beta*(sin\gamma)^2 \\
   &= cos\beta
   
   \end{aligned}
   $$
   接下来计算伴随阵：

   先计算代数余子式：

   $A_{11} = (+) \begin{vmatrix} cos\gamma && 0 \\ 0 && 1 \end{vmatrix} = cos\gamma$​

   $A_{12} = (-) \begin{vmatrix} cos\beta sin\gamma && 0 \\ -sin\beta && 1 \end{vmatrix} = -cos\beta sin\gamma$

   $A_{13} = (+) \begin{vmatrix} cos\beta sin\gamma && cos\gamma \\ -sin\beta && 0 \end{vmatrix} = sin\beta cos\gamma$

   $A_{21} = (-) \begin{vmatrix} -sin\gamma && 0 \\ 0 && 1 \end{vmatrix} = sin\gamma$​

   $A_{22} = (+) \begin{vmatrix} cos\beta cos\gamma && 0 \\ -sin\beta && 1 \end{vmatrix} = cos\beta cos\gamma$

   $A_{23} = (-) \begin{vmatrix} cos\beta cos\gamma && -sin\gamma \\ -sin\beta && 0 \end{vmatrix} = sin\beta sin\gamma$

   $A_{31} = (+) \begin{vmatrix} -sin\gamma && 0 \\ cos\gamma && 0 \end{vmatrix} = 0$

   $A_{32} = (-) \begin{vmatrix} cos\beta cos\gamma && 0 \\ cos\beta sin\gamma && 0 \end{vmatrix} = 0$

   $A_{33} = (+) \begin{vmatrix} cos\beta cos\gamma && -sin\gamma \\ cos\beta sin\gamma && cos\gamma \end{vmatrix} = cos\beta$
   $$
   \begin{aligned}
   C &= 
   \begin{bmatrix}
   cos\gamma && -cos\beta sin\gamma && sin\beta cos\gamma \\
   sin\gamma && cos\beta cos\gamma && sin\beta sin\gamma \\
   0 && 0 && cos\beta
   \end{bmatrix}
   \end{aligned}
   $$
   
   $$
   \begin{aligned}
   A^* &= 
   \begin{bmatrix}
   cos\gamma && sin\gamma &&  0\\
   -cos\beta sin\gamma  && cos\beta cos\gamma && 0 \\
   sin\beta cos\gamma && sin\beta sin\gamma && cos\beta
   \end{bmatrix}
   \end{aligned}
   $$

   $$
   \begin{aligned}
   A^{-1} &= {A^* \over det(A)}  \\
   &= 
   \begin{bmatrix}
   {cos\gamma / cos\beta} && {sin\gamma / cos\beta} && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   {sin\beta cos\gamma / cos\beta} && {sin\beta sin\gamma / cos\beta} && 1
   \end{bmatrix}
   \end{aligned}
   $$

   那么此时可以得到欧拉角微分与角速度之间的关系：
   $$
   \begin{aligned}
   \begin{bmatrix}
   \dot{\alpha} \\
   \dot{\beta} \\
   \dot{\gamma} \\
   \end{bmatrix} &= 
   \begin{bmatrix}
   {cos\gamma / cos\beta} && {sin\gamma / cos\beta} && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   {sin\beta cos\gamma / cos\beta} && {sin\beta sin\gamma / cos\beta} && 1
   \end{bmatrix} *
   \begin{bmatrix}
   \omega_x^i \\
   \omega_y^i \\
   \omega_z^i \\
   \end{bmatrix} \\
   
   &=
   \begin{bmatrix}
   {cos\gamma / cos\beta} && {sin\gamma / cos\beta} && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   {tan\beta cos\gamma} && {tan\beta sin\gamma} && 1
   \end{bmatrix} *
   \begin{bmatrix}
   \omega_x^i \\
   \omega_y^i \\
   \omega_z^i \\
   \end{bmatrix} \\
   
   \end{aligned}
   $$
   

   

   

   下面分别计算各个部分的矩阵如下：
   $$
   \begin{aligned}
   \begin{bmatrix}
   -sin\gamma && -cos\gamma && 0 \\
   cos\gamma && -sin\gamma && 0 \\
   0 && 0 && 0
   \end{bmatrix} R_z^T &= 
   \begin{bmatrix}
   -sin\gamma && -cos\gamma && 0 \\
   cos\gamma && -sin\gamma && 0 \\
   0 && 0 && 0
   \end{bmatrix} 
   \begin{bmatrix}
   cos\gamma && sin\gamma && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   0 && 0 && 1 
   \end{bmatrix} \\
   &= 
   \begin{bmatrix}
   0 && -1 && 0 \\
   1 && 0 && 0 \\
   0 && 0 && 0
   \end{bmatrix}
   \end{aligned}
   $$

   $$
   \begin{aligned}
   R_z
   \begin{bmatrix}
   -sin\beta && 0 && cos\beta \\
   0 && 0 && 0 \\
   -cos\beta && 0 && -sin\beta 
   \end{bmatrix} R_y^T R_z^T 
   &= 
   R_z
   \begin{bmatrix}
   -sin\beta && 0 && cos\beta \\
   0 && 0 && 0 \\
   -cos\beta && 0 && -sin\beta 
   \end{bmatrix}
   \begin{bmatrix}
   cos\beta && 0 && -sin\beta \\
   0 && 1 && 0 \\
   sin\beta && 0 && cos\beta 
   \end{bmatrix}
   R_z^T \\
   &= 
   \begin{bmatrix}
   cos\gamma && -sin\gamma && 0 \\
   sin\gamma && cos\gamma && 0 \\
   0 && 0 && 1 
   \end{bmatrix}
   \begin{bmatrix}
   0 && 0 && 1 \\
   0 && 0 && 0 \\
   -1 && 0 && 0 \\
   \end{bmatrix}
   \begin{bmatrix}
   cos\gamma && sin\gamma && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   0 && 0 && 1 
   \end{bmatrix} \\
   &= 
   \begin{bmatrix}
   0 && 0 && cos\gamma \\
   0 && 0 && sin\gamma \\
   -1 && 0 && 0
   \end{bmatrix}
   \begin{bmatrix}
   cos\gamma && sin\gamma && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   0 && 0 && 1 
   \end{bmatrix} \\
   &= 
   \begin{bmatrix}
   0 && 0 && cos\gamma \\
   0 && 0 && sin\gamma \\
   -cos\gamma && -sin\gamma && 0
   \end{bmatrix}
   \end{aligned}
   $$

   $$
   \begin{aligned}
   R_z R_y \begin{bmatrix}
   0 && 0 && 0 \\
   0 && -sin\alpha && -cos\alpha \\
   0 && cos\alpha && -sin\alpha
   \end{bmatrix} R_x^T R_y^T R_z^T 
   
   &= 
   R_z R_y
   \begin{bmatrix}
   0 && 0 && 0 \\
   0 && -sin\alpha && -cos\alpha \\
   0 && cos\alpha && -sin\alpha
   \end{bmatrix}
   \begin{bmatrix}
   1 && 0 && 0 \\
   0 && cos\alpha && sin\alpha \\
   0 && -sin\alpha && cos\alpha 
   \end{bmatrix}
   R_y^T R_z^T \\
   
   &=
   R_z R_y
   \begin{bmatrix}
   0 && 0 && 0 \\
   0 && 0 && -1 \\
   0 && 1 && 0
   \end{bmatrix}
   R_y^T R_z^T \\
   
   &= 
   R_z 
   \begin{bmatrix}
   cos\beta && 0 && sin\beta \\
   0 && 1 && 0 \\
   -sin\beta && 0 && cos\beta 
   \end{bmatrix}
   \begin{bmatrix}
   0 && 0 && 0 \\
   0 && 0 && -1 \\
   0 && 1 && 0
   \end{bmatrix}
   \begin{bmatrix}
   cos\beta && 0 && -sin\beta \\
   0 && 1 && 0 \\
   sin\beta && 0 && cos\beta 
   \end{bmatrix}
   R_z^T \\
   
   &=
   R_z 
   \begin{bmatrix}
   0 && sin\beta && 0 \\
   -sin\beta && 0 && -cos\beta \\
   0 && cos\beta && 0
   \end{bmatrix}
   R_z^T \\
   
   &=
   \begin{bmatrix}
   cos\gamma && -sin\gamma && 0 \\
   sin\gamma && cos\gamma && 0 \\
   0 && 0 && 1 
   \end{bmatrix}
   \begin{bmatrix}
   0 && sin\beta && 0 \\
   -sin\beta && 0 && -cos\beta \\
   0 && cos\beta && 0
   \end{bmatrix}
   \begin{bmatrix}
   cos\gamma && sin\gamma && 0 \\
   -sin\gamma && cos\gamma && 0 \\
   0 && 0 && 1 
   \end{bmatrix} \\
   
   &=
   \begin{bmatrix}
   0 && sin\beta && cos\beta sin\gamma \\
   -sin\beta && 0 && -cos\beta cos\gamma \\
   -cos\beta sin\gamma && cos\beta cos\gamma && 0
   \end{bmatrix}
   
   \end{aligned}
   $$

   

2. 局部坐标系角速度

我们可以在全局坐标系角速度和欧拉角微分的关系直接推导：
$$
\begin{aligned}
\begin{bmatrix}
\dot{\alpha} \\
\dot{\beta} \\
\dot{\gamma} \\
\end{bmatrix} &= 
\begin{bmatrix}
{cos\gamma / cos\beta} && {sin\gamma / cos\beta} && 0 \\
-sin\gamma && cos\gamma && 0 \\
{sin\beta cos\gamma / cos\beta} && {sin\beta sin\gamma / cos\beta} && 1
\end{bmatrix} *
\begin{bmatrix}
\omega_x^i \\
\omega_y^i \\
\omega_z^i \\
\end{bmatrix} \\

&=
\begin{bmatrix}
{cos\gamma / cos\beta} && {sin\gamma / cos\beta} && 0 \\
-sin\gamma && cos\gamma && 0 \\
{tan\beta cos\gamma} && {tan\beta sin\gamma} && 1
\end{bmatrix} *
\begin{bmatrix}
\omega_x^i \\
\omega_y^i \\
\omega_z^i \\
\end{bmatrix} \\

&=
\begin{bmatrix}
{cos\gamma / cos\beta} && {sin\gamma / cos\beta} && 0 \\
-sin\gamma && cos\gamma && 0 \\
{tan\beta cos\gamma} && {tan\beta sin\gamma} && 1
\end{bmatrix} * R_{ib} * \vec{\omega}_b \\

&=
\begin{bmatrix}
1 && sin\alpha tan\beta && cos\alpha tan\beta \\
0 && cos\alpha && -sin\alpha \\
0 && sin\alpha/cos\beta && cos\alpha /cos\beta
\end{bmatrix} * \vec{\omega}_b

\end{aligned}
$$


到这里我们就清楚了为什么网上那么多的推导，结果形式有的差异很大，原来有的了公式描述的是全局角速度，有的描述的是局部角速度

https://blog.csdn.net/qq_39554681/article/details/89504070

https://zhuanlan.zhihu.com/p/651682566

推导了完成了这些，也为我们将来学习MPC控制算法打下了基础。

# 旋转矩阵微分方程推导

记录一下 角速度 $\vec{\omega}$ 与 旋转矩阵 $R$ 之间的关系的推导过程

## 质点线速度与角速度的关系

$$
\vec{v} = \vec{\omega} \times \vec{r}
$$

其中 $\vec{v}$ 为质点线速度，$\vec{\omega}$ 为角速度，$\vec{r}$ 为质点在直角坐标系下的矢径

## 旋转矩阵

$$
R_{ib} = \begin{bmatrix}
\vec{x_{ib}} & \vec{y_{ib}} & \vec{z_{ib}}
\end{bmatrix} 
$$

其中 $i$ 表示全局坐标系，$b$表示局部坐标系，$\vec{x_{ib}}$、$\vec{y_{ib}}$、$\vec{z_{ib}}$ 为旋转矩阵的列向量，分别是$b$坐标系的x轴，y轴，z轴的单位向量在全局坐标系下的坐标


## 推导过程1（全局坐标系角速度与旋转矩阵的关系）
$$
\begin{aligned}
\dot{R_{ib}} &= \begin{bmatrix}
\dot{\vec{x_{ib}}} & \dot{\vec{y_{ib}}} & \dot{\vec{z_{ib}}}
\end{bmatrix}  \\
&= \begin{bmatrix}
\vec{\omega_i} \times \vec{x_{ib}} & \vec{\omega_i} \times \vec{y_{ib}} & \vec{\omega_i} \times \vec{z_{ib}}
\end{bmatrix} \\
&= \begin{bmatrix}
S(\vec{\omega_i}) \cdot \vec{x_{ib}} & S(\vec{\omega_i}) \cdot \vec{y_{ib}} & S(\vec{\omega_i}) \cdot \vec{z_{ib}}
\end{bmatrix} \\
&= S(\vec{\omega_i}) \cdot R_{ib}
\end{aligned}
$$

注意 $\vec{\omega_i}$ 为刚体在全局坐标系下的角速度
但是更多的时候，已知的是传感器上获取到的角速度，这些传感器固连在运动物体上，因此获取局部坐标系的角速度和旋转矩阵之间的关系会更有意义。

## 推导过程2（局部坐标系角速度与旋转矩阵的关系）

### 角速度变换原理
$$
\vec{\omega_i} = R_{ib} \cdot \vec{\omega_b}
$$

### 叉乘分配率
两个向量的相对位置关系在两个向量经过相同旋转后，不会发生改变
$$
R_{ib}\vec{p_b} \times R_{ib}\vec{q_b} = R_{ib}(\vec{p_b} \times \vec{q_b})
$$

### 反对称运算分配率
$$
(R \cdot \vec{p})^{\land} =  R \cdot \vec{p}^{\land} \cdot R^{T}
$$
#### 证明
$$
\begin{aligned}
(R \cdot \vec{p})^{\land} \cdot \vec{v} &= (R \cdot \vec{p}) \times \vec{v} \\
&= R \cdot R^T \cdot [(R \cdot \vec{p}) \times \vec{v}] \\
&= [R \cdot R^T \cdot (R \cdot \vec{p})] \times [R \cdot R^T \cdot \vec(v)] \\
&= R \cdot ( [R^T \cdot R \cdot \vec{p}] \times [R^T \cdot \vec{v}]) \\
&= R \cdot (\vec{p} \times (R^T \cdot \vec{v})) \\ 
&= R \cdot \vec{p}^\land \cdot R^T \cdot \vec{v}
\end{aligned}
$$

### 推导过程
$$
\begin{aligned}
\dot{R_{ib}} &= S(\vec{\omega_i}) \cdot R_{ib} \\
&= S(R_{ib} \cdot \vec{\omega_b}) \cdot R_{ib} \\
&= R_{ib} \cdot S(\vec{\omega_b}) \cdot R_{ib}^T \cdot R_{ib} \\
&= R_{ib} \cdot S(\vec{\omega_b})
\end{aligned}
$$

# 四元数微分方程推导

## 基础知识

1. 四元数的负数表示方法

   $\vec{q} = q_0 + q_1\vec{i} + q_2\vec{j} + q_3\vec{k} = \begin{bmatrix} q_0 \\ q_1 \\ q_2 \\q_3 \end{bmatrix}$

2. 四元数的共轭

   $\vec{q}^* = q_0 - q_1\vec{i} - q_2\vec{j} - q_3\vec{k} = \begin{bmatrix} q_0 \\ -q_1 \\ -q_2 \\-q_3 \end{bmatrix}$

3. 四元数的模长

   $\lVert q \rVert^2 = q \otimes q^* = q^* \otimes q = q_0^2+q_1^2+q_2^2+q_3^2$

4. 四元数的逆

   $q \otimes q^{-1} = q^{-1} \otimes q = 1$

   $q^{-1} = q^* / \lVert q \rVert^2$

5. 单位四元数

   模长为1的四元数叫做单位四元数

   **单位四元数的共轭等于它的逆！**

6. 四元数表示旋转

   $P' = q \otimes P \otimes q^{-1} $​

   同时对于任意非零$a$，$aq$和$q$表示同一个旋转

   $(aq)P(aq)^{-1}=aqPq^{-1}1/a=qPq^{-1}$ 

7. 单位四元数对应的旋转

   这个单位四元数对应于绕旋转轴$A$旋转$\theta$角度的旋转变换

   $q = cos{\theta \over 2} + Asin{\theta \over 2}$

8. 四元数的左乘和右乘
   $$
   \begin{aligned}
   q \cdot p &= L(q)p 
   = 
   \begin{bmatrix}
   q_0 && -q_1 && -q_2 && -q_3 \\
   q_1 && q_0 && -q_3 && q_2 \\
   q_2 && q_3 && q_0 && -q_1 \\
   q_3 && -q_2 && q_1 && q_0
   \end{bmatrix}
   \begin{bmatrix}
   p_0 \\
   p_1 \\
   p_2 \\
   p_3
   \end{bmatrix} \\
   
   &= R(p)q = 
   \begin{bmatrix}
   p_0 && -p_1 && -p_2 && -p_3 \\
   p_1 && p_0 && p_3 && -p_2 \\
   p_2 && -p_3 && p_0 && p_1 \\
   p_3 && p_2 && -p_1 && p_0
   \end{bmatrix}
   \begin{bmatrix}
   q_0 \\
   q_1 \\
   q_2 \\
   q_3
   \end{bmatrix} \\
   
   \end{aligned}
   $$
   

9. 微分方程
   $$
   \begin{aligned}
   \dot{Q_{ib}} &= {1 \over 2} \omega_{ib}^i \otimes Q_{ib} \\
   &= {1 \over 2} R(Q_{ib}) \omega_{ib}^i  \\
   &= {1 \over 2} Q_{ib} \otimes \omega_{ib}^b \\
   &= {1 \over 2} L(Q_{ib}) \omega_{ib}^b  \\
   \end{aligned}
   $$
   其中$\omega_{ib}^i$表示$b$系相对于$i$系转动的角速度在$i$系的表达，$\omega_{ib}^b$表示$b$系相对于$i$系转动的角速度在$b$​系的表达

   通常$\omega_{ib}^b$​可以通过imu的测量得到

   其中$Q_{ib}$为单位四元数，可以将$b$系中的向量旋转到$i$系中来：$\vec{r}_i = Q_{ib} \otimes\vec{r}_b\otimes Q_{ib}^{-1}$

10. 微分方程具体推导

    TODO， 因为网上提供的一些证明，目前存在一些不合理的假设，所以这里没有记录详细的推导过程，等看到很信服的推导后再进行更新。

    

# 参考资料

[参考资料](https://zhuanlan.zhihu.com/p/681296457)

https://zhuanlan.zhihu.com/p/77992837